#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

# Keep this path for calling _common.sh inside the execution's context of backup and restore scripts
source ../settings/scripts/_common.sh
source /usr/share/yunohost/helpers

#=================================================
# INSTALL JITSI
#=================================================

echo jitsi-videobridge2 jitsi-videobridge/jvb-hostname string "$domain"   | debconf-set-selections
echo jitsi-meet-web-config jitsi-meet/cert-choice string "I want to use my own certificate"  | debconf-set-selections
echo jitsi-meet-web-config jitsi-meet/cert-path-key string "/etc/yunohost/certs/$domain/key.pem" | debconf-set-selections
echo jitsi-meet-web-config jitsi-meet/cert-path-crt string "/etc/yunohost/certs/$domain/crt.pem" | debconf-set-selections
echo jitsi-meet-web-config jitsi-meet/jaas-choice select false | debconf-set-selections

ynh_apt_install_dependencies_from_extra_repository --repo="deb https://download.jitsi.org stable/" --package="jitsi-meet prosody-modules" --key="https://download.jitsi.org/jitsi-key.gpg.key"


#=================================================
# REPLACE JNIWRAPPER FOR ARMHF ARCHITECTURE IN JITSI-VIDEOBRIDGE
#=================================================

if [ "$YNH_ARCH" == "armhf" ]; then
    ynh_script_progression --message="Configuring jniwrapper for armhf ..." --weight=1
    ynh_jniwrapper_armhf
fi

chmod 750 "$install_dir"
chmod -R o-rwx "$install_dir"
chown -R "$app:$app" "$install_dir"

#=================================================
# LDAP CONFIGURATION
#=================================================

if [ $enable_ldap -eq 1 ]
then
    ynh_script_progression "Configuring LDAP..."

	ynh_restore "/etc/prosody/conf.avail/$domain.cfg.lua"

	ynh_restore "/etc/jitsi/jicofo/jicofo.conf"

	ynh_restore "/etc/jitsi/meet/$domain-config.js"

	ynh_restore "/usr/share/jitsi-meet/prosody-plugins/mod_auth_ldap.lua"
fi

#=================================================
# RESTORE SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression "Restoring system configurations related to $app..."

ynh_safe_rm "/etc/nginx/sites-enabled/$domain.conf"

ynh_restore "/etc/nginx/conf.d/$domain.d/$app.conf"

yunohost service add "jitsi-videobridge2" --log="/var/log/jitsi/jvb.log" --needs_exposed_ports "$port" "$port_videobridge"

yunohost service add "jicofo" --log="/var/log/jitsi/jicofo.log"

ynh_restore "/var/log/$app/"
chown -R "$app:" "/var/log/$app"
chmod -R 770 "/var/log/$app"

#=================================================
# RELOAD NGINX AND PHP-FPM OR THE APP SERVICE
#=================================================
ynh_script_progression "Reloading NGINX web server and $app's service..."

ynh_systemctl --service="prosody" --action="restart" --log_path="/var/log/prosody/prosody.log"
ynh_systemctl --service="jicofo" --action="restart" --log_path="/var/log/jitsi/jicofo.log"
ynh_systemctl --service="jitsi-videobridge2" --action="restart" --log_path="/var/log/jitsi/jvb.log"

ynh_systemctl --service=nginx --action=reload

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Restoration completed for $app"
